---
title: "Project 1"
author: "Brian Sugg"
date: "6/12/2020"
output:
  rmarkdown::github_document:
    toc: true
    toc_depth: 3
---

```{r setupOptions, include=FALSE}
library(tidyverse)
library(Lahman)
library(formatR)
library(dplyr)
library(httr)
library(jsonlite)
library(DT)
library(ggplot2)
library(knitr)
knitr::opts_chunk$set(message=FALSE,tidy.opts=list(width.cutoff=70),tidy=TRUE)
```

# Introduction to JSON Data  

## Background  

JSON stands for JavaScript Object Notation and is simply a method for writing out data objects using the JavaScript language for quick and efficient transmission between servers and browsers. JavaScript is a lightweight programming language with less syntax notation that makes it easy to read, write, and store data. The lightweight structure of JSON makes it a great way to quickly and efficiently send large amounts of data with minimal wait time and storage size.  

JSON is commonly used when creating and consuming data via API connections. It can ingest text strings, numbers, boolean values, `null` values, arrays, and objects into long strings of text that get delivered to a client for processing. An example from the [Mozilla Developers](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON) webpage helps illustrate how data describing a superhero, "Molecule Man", would look in JavaScript format within a JSON file:  

`{"name":"Molecule Man","age": 29,"secretIdentity":"Dan Jukes","powers":["Radiation resistance","Turning tiny","Radiation blast"]}`

This file can be received and unpackaged by a browser for parsing back into a consumable format, such as:

```{r molecule.png, out.width="30%", echo=FALSE}
knitr::include_graphics("images/moleculeMan.PNG")
```

More information on JSON including its history and usage can be found in the [Wikipedia](https://en.wikipedia.org/wiki/JSON) community. The following sections will look further into how JSON files can be unpackaged and parsed into R, including an example connection to an API for the National Hockey League (NHL).  

## Reading JSON DATA into R  

There are several packages available for reading JSON data into R. Some of these packages, such as `rjson`, have been around for a few years providing functionality as a predecessor for future packages to improve upon. Three major packages will be discussed further below with links to their respective documentation in the Comprehensive R Archive Network (CRAN). They include:  

* `rjson`  
* `RJSONIO`  
* `jsonlite`  

In the spirit of open source development, the evolution of other packages for converting between JSON and R still continues today. This is evident in the recent release version of the [`tidyjson`](https://cran.r-project.org/package=tidyjson) package on 31-May-2020.  

### Package 1 - rjson:  

The `rjson` package was an early effort in converting data between JSON and R. Its two primary functions are:  

* `toJSON()` for converting R objects to JSON format  
* `fromJSON()` for converting from JSON format into R objects  

In early release versions, `rjson` was reportedly too slow for converting large R objects into JSON format. The need for a faster conversion would eventually lead to the creation of the `RJSONIO` package.  

*[Link](https://cran.r-project.org/package=rjson) to CRAN documentation for a more exhaustive list of `rjson` functions and their arguments.*  

### Package 2 - RJSONIO:

Building upon the functionality of `rjson`, the `RJSONIO` package offers faster conversions and additional functions for troubleshooting the parsing process. Both `fromJSON()` and `toJSON()` are enhanced and still available, and new functions introduced, such as:  

* `isValidJSON()` for validating JSON format prior to parsing, which helps when troublehsooting errors  
* `readJSONStream()` that optimizes system memory and processing for the ingestion of streaming JSON content  

Overall, `RJSONIO` has additional options for the generation and processing of JSON content, while sharing a similar look and feel of `rjson`.   

*[Link](https://cran.r-project.org/package=RJSONIO) to CRAN documentation for a more exhaustive list of `RJSONIO` functions and their arguments.*  

### Package 3 - jsonlite:  

Originally a fork of the `RJSONIO` package, the `jsonlite` package is one of the newer options available for parsing JSON data in R. It has been designed and optimized for interaction with web APIs. The core functions of `fromJSON()` and `toJSON()` remain, however, they have been rewritten for better consistency when converting between JSON and R. Other functions for `jsonlite` include:  

* `validate()` for validating the structure of JSON content (similar to `isValidJSON()` in `RJSONIO`)  
* `prettify()` adds indentation to JSON strings for better readability  
* `minify()` for removing all indendation and whitespace  
* `stream_in()` and `stream_out()` for handling streaming JSON connections  

Overall, `jsonlite` is a fast JSON parser and useful for the conversion of JSON script into nested lists in R. Given its speed and high performance, `jsonlite` is a powerful package for anyone interested in JSON to R conversions, particularly when APIs are involved. 

*[Link](https://cran.r-project.org/package=jsonlite) to CRAN documentation for a more exhaustive list of `jsonlite` functions and their arguments.*  

## Package for this Vignette  

Given its optimization for parsing JSON script from APIs, the `jsonlite` package is used in this vignette when communicating with the API for NHL records. Its fast speed and ease of use when coupled with the `httr` package makes it a preferred candidate for converting JSON into R objects.  

In the following "NHL Franchise API" section, the `GET()` and `content()` functions from `httr` will be used to call a URL and return a JSON text string. The `fromJSON()` function from `jsonlite` will then be utilized for parsing the raw text into a R list object. Finally, the data table from the R list object will be pulled and converted into a tibble for data analysis.   

# NHL Franchise API  

## Background  

The professional hockey league across the United States and Canada is the  National Hockey League (NHL), which provides an API for public consumption. The NHL offers almost no official documentation for this connection and its available endpoints. To help navigate this API, open source documentation from this [GitLab](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) will be used to understand what data is available, relevant URL addresses, and how to filter on certain attributes in the API query.  

The following sections will focus primarily on retrieving data for NHL franchises, players (goalies and skaters), and season stats. Some numerical summaries will be presented, along with the exploration of analytical summaries containing visuals of various plots.  

## Establishing API Connection  

The base URL for the NHL API is `https://records.nhl.com/site/api` which can be called with different extensions such as `/franchise` to retrieve data from a specific endpoint, or additionally with a Franchise ID such as `26` (Carolina Hurricanes) to return data filtered on specific franchises.  

Two functions below have been created for calling the NHL API:  

* `nhlTable(tableName)` calls the provided endpoint from the user, parses, and returns a tibble of that endpoint.  
* `nhlTableWithFranchiseId(tableName,franId)` calls the provided endpoint and the desired Franchise ID from the user, parses, and returns a tibble of that endpoint filtered on the respective franchise.  

These functions will be used to call the following endpoints, creating tibbles for each:  

* `/franchise` to create table `fran`  
* `/franchise-team-totals` to create table `franTot`  
* `/franchise-season-records` to create table `franSeason`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-goalie-records` to create table `franGoal`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-skater-records` to create table `franSkate`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  

These tables will be used in the upcoming section on "Exploratory Data Analysis".  

```{r nhlApiFunctions}
nhlTable <- function(tableName){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
nhlTableWithFranchiseId <- function(tableName,franId){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName,"?cayenneExp=franchiseId=",franId))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
# Function calls for 5 different endpoints, with 3 calling franchiseId=26 for data specific to the Carolina Hurricanes:
fran <- nhlTable("/franchise")
fran
franTot <- nhlTable("/franchise-team-totals")
franTot
franSeason <- nhlTableWithFranchiseId("/franchise-season-records",26)
franSeason
franGoal <- nhlTableWithFranchiseId("/franchise-goalie-records",26)
franGoal
franSkate <- nhlTableWithFranchiseId("/franchise-skater-records",26)
franSkate
```

## Exploratory Data Analysis  

### The Data  

Two tables from the API query will be modfied and examined further. The table `fran` with franchise data has been formatted with two additional variables, some variables have been renamed for better understanding, columns selected in the order of desired appearance, and the overall table arranged by `teamName`.  

The table `franSkate` with player skater data for the Carolina Hurricanes has been formatted with one additional variable, another categorical variable now has replaced values for better understanding of player position,  columns selected in the order of desired appearance, and the overall table arranged by `gamesPlayed`.  

```{r tableFormat}
# Format "fran" table and create modified version. Add 2 new variables, "teamName" and "activeTeam". Rename variables as needed. Select relevant varibales and arrange by "teamName".
franMod <- fran %>% mutate(teamName=paste(fran$teamPlaceName,fran$teamCommonName)) %>% mutate(activeTeam=as.integer(is.na(lastSeasonId))) %>%  rename("franchiseId"="id","teamId"="mostRecentTeamId") %>% select(teamName,franchiseId,teamId,firstSeasonId,lastSeasonId,activeTeam) %>% arrange(teamName)
# Format "franSkate" table and create modified version. Add 1 new variable, "playerName" and arrange by gamesPlayed. Replace levels of categorical variable "positionCode" with full position name. Select relevant varibales in desired order.
franSkateMod <- franSkate %>% mutate(playerName=paste(franSkate$firstName,franSkate$lastName)) %>% mutate(avgPointsPerSeason=round(points/seasons,1)) %>%  mutate(avgGoalsPerSeason=round(goals/seasons,1)) %>% mutate(avgAssistsPerSeason=round(assists/seasons,1)) %>%  mutate(avgPenaltyMinutesPerSeason=round(penaltyMinutes/seasons,1)) %>% mutate(avgGamesPlayedPerSeason=round(gamesPlayed/seasons,1)) %>% mutate(seniority=seasons) %>% arrange(desc(gamesPlayed))
franSkateMod$positionCode <- factor(franSkateMod$positionCode,c("C","D","L","R"),labels = c("Center","Defenseman","Left Wing","Right Wing"))
franSkateMod$seniority <- factor(ifelse(franSkateMod$seniority==1,"1 year Rookie",ifelse(franSkateMod$seniority<=5,"2-5 year Veteran","6+ year Seasoned Veteran")))
franSkateMod$activePlayer <- factor(ifelse(franSkateMod$activePlayer=="TRUE","Active","NonActive"))
franSkateMod <- franSkateMod %>% rename("position"="positionCode") %>% filter(gamesPlayed>=10) %>% select(playerName, playerId, activePlayer, position, seasons, seniority, gamesPlayed, points, goals, assists, penaltyMinutes, avgPointsPerSeason, avgGoalsPerSeason, avgAssistsPerSeason, avgPenaltyMinutesPerSeason, avgGamesPlayedPerSeason)
```

```{r showTables, echo=FALSE}
# Preview tables
knitr::kable(head(franMod,n=10),format="html",caption="Preview of Modified Franchise Data")
knitr::kable(head(franSkateMod,n=10),format="html",caption="Preview of Modified Skater Data for Carolina Hurricanes")
# Contingency tables
knitr::kable(table(franSkateMod$position,franSkateMod$seniority),format="html",caption="Frequency of Skater Position by Seniority")
knitr::kable(table(franSkateMod$activePlayer,franSkateMod$position),format="html",caption="Frequency of Active Players by Skater Position")
```

### Numeric Summaries  

Provide contingecy tables and numeric summaries as required.  

```{r summaryOfRetiredSkaterByPosition, echo=FALSE}
# Function created that takes NonActive players by position and outputs a numeric summary of key stats
skateSum <- function(x=""){
  skateFun <- franSkateMod %>% filter(position==x,activePlayer=="NonActive")
  knitr::kable(cbind("Seasons Played"=round(summary(skateFun$seasons),1),"Games Played"=round(summary(skateFun$gamesPlayed),1),"Goals Scored"=round(summary(skateFun$goals),1),"Assists Given"=round(summary(skateFun$assists),1)),format="html",caption=paste("Summary of NonActive Players for Skater Position:",x))
}
# Call custom function 4 times, once per skater position.
skateSum("Defenseman")
skateSum("Center")
skateSum("Left Wing")
skateSum("Right Wing")
```


### Visuals  

Create some plots (bar, box, scatter) with discussion of observations for each.  

```{r plots, echo=FALSE}
# Histogram creation
histSkate <- ggplot(data=franSkateMod,aes(x=seasons))
histSkate + geom_histogram(bins=10) + labs(title="Histogram of Seasons Played")
# Cluster bar chart creation
clustSkate <- ggplot(data=franSkateMod,aes(x=position))
clustSkate + geom_bar(aes(fill=as.factor(seniority)),position="dodge") + labs(x="Player Position") + scale_fill_discrete(name="")
# Boxplot creation by player position
boxSkatePoints <- ggplot(data=franSkateMod)
boxSkatePoints + geom_boxplot(aes(x=position,y=avgPointsPerSeason,)) + geom_jitter(aes(x=position,y=avgPointsPerSeason,color=position)) + labs(title="Boxplot for Average Points Per Season")
boxSkateGoal <- ggplot(data=franSkateMod)
boxSkateGoal + geom_boxplot(aes(x=position,y=avgGoalsPerSeason,)) + geom_jitter(aes(x=position,y=avgGoalsPerSeason,color=position)) + labs(title="Boxplot for Average Goals Per Season")
boxSkateAssist <- ggplot(data=franSkateMod)
boxSkateAssist + geom_boxplot(aes(x=position,y=avgAssistsPerSeason,)) + geom_jitter(aes(x=position,y=avgAssistsPerSeason,color=position)) + labs(title="Boxplot for Average Assists Per Season")
boxSkatePenalty <- ggplot(data=franSkateMod)
boxSkatePenalty + geom_boxplot(aes(x=position,y=avgPenaltyMinutesPerSeason,)) + geom_jitter(aes(x=position,y=avgPenaltyMinutesPerSeason,color=position)) + labs(title="Boxplot for Average Penalty Minutes Per Season")
# Boxplot creation by player seniority
boxSkatePoints <- ggplot(data=franSkateMod)
boxSkatePoints + geom_boxplot(aes(x=seniority,y=avgPointsPerSeason,)) + geom_jitter(aes(x=seniority,y=avgPointsPerSeason,color=seniority)) + labs(title="Boxplot for Average Points Per Season")
boxSkateGoal <- ggplot(data=franSkateMod)
boxSkateGoal + geom_boxplot(aes(x=seniority,y=avgGoalsPerSeason,)) + geom_jitter(aes(x=seniority,y=avgGoalsPerSeason,color=seniority)) + labs(title="Boxplot for Average Goals Per Season")
boxSkateAssist <- ggplot(data=franSkateMod)
boxSkateAssist + geom_boxplot(aes(x=seniority,y=avgAssistsPerSeason,)) + geom_jitter(aes(x=seniority,y=avgAssistsPerSeason,color=seniority)) + labs(title="Boxplot for Average Assists Per Season")
boxSkatePenalty <- ggplot(data=franSkateMod)
boxSkatePenalty + geom_boxplot(aes(x=seniority,y=avgPenaltyMinutesPerSeason,)) + geom_jitter(aes(x=seniority,y=avgPenaltyMinutesPerSeason,color=seniority)) + labs(title="Boxplot for Average Penalty Minutes Per Season")
# Scatter plot creation
scatterSkate <- ggplot(data=franSkateMod,aes(x=avgGoalsPerSeason,y=avgAssistsPerSeason,color=position,group=position))
scatterSkate + geom_point() + geom_smooth(method=lm,color="green") + labs(title="avgGoalsPerSeason vs avgPenaltyMinutesPerSeason")
scatterSkate2 <- ggplot(data=franSkateMod,aes(x=seasons,y=avgGoalsPerSeason,color=position,group=position))
scatterSkate2 + geom_point() + geom_smooth(method=lm) + labs(x="Seasons Played",y="Average Goals Scored Per Season Played",title="Seasons Played vs Average Goals Scored Per Season")
```
