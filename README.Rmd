---
title: "Project 1"
author: "Brian Sugg"
date: "6/12/2020"
output:
  rmarkdown::github_document:
    toc: true
    toc_depth: 3
---

```{r setupOptions, include=FALSE}
library(tidyverse)
library(Lahman)
library(formatR)
library(dplyr)
library(httr)
library(jsonlite)
library(DT)
library(ggplot2)
library(knitr)
knitr::opts_chunk$set(message=FALSE,tidy.opts=list(width.cutoff=70),tidy=TRUE)
```

# Introduction to JSON Data  

## Background  

JSON stands for JavaScript Object Notation and is simply a method for writing out data objects using the JavaScript language for quick and efficient transmission between servers and browsers. JavaScript is a lightweight programming language with less syntax notation that makes it easy to read, write, and store data. The lightweight structure of JSON makes it a great way to quickly and efficiently send large amounts of data with minimal wait time and storage size.  

JSON is commonly used when creating and consuming data via API connections. It can ingest text strings, numbers, boolean values, `null` values, arrays, and objects into long strings of text that get delivered to a client for processing. An example from the [Mozilla Developers](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON) webpage helps illustrate how data describing a superhero, "Molecule Man", would look in JavaScript format within a JSON file:  

`{"name":"Molecule Man","age": 29,"secretIdentity":"Dan Jukes","powers":["Radiation resistance","Turning tiny","Radiation blast"]}`

This file can be received and unpackaged by a browser for parsing back into a consumable format, such as:

```{r molecule.png, out.width="30%", echo=FALSE}
knitr::include_graphics("images/moleculeMan.PNG")
```

More information on JSON including its history and usage can be found in the [Wikipedia](https://en.wikipedia.org/wiki/JSON) community. The following sections will look further into how JSON files can be unpackaged and parsed into R, including an example connection to an API for the National Hockey League (NHL).  

## Reading JSON DATA into R  

There are several packages available for reading JSON data into R. Some of these packages, such as `rjson`, have been around for a few years providing functionality as a predecessor for future packages to improve upon. Three major packages will be discussed further below with links to their respective documentation in the Comprehensive R Archive Network (CRAN). They include:  

* `rjson`  
* `RJSONIO`  
* `jsonlite`  

In the spirit of open source development, the evolution of other packages for converting between JSON and R still continues today. This is evident in the recent release version of the [`tidyjson`](https://cran.r-project.org/package=tidyjson) package on 31-May-2020.  

### Package 1 - rjson:  

The `rjson` package was an early effort in converting data between JSON and R. Its two primary functions are:  

* `toJSON()` for converting R objects to JSON format  
* `fromJSON()` for converting from JSON format into R objects  

In early release versions, `rjson` was reportedly too slow for converting large R objects into JSON format. The need for a faster conversion would eventually lead to the creation of the `RJSONIO` package.  

*[Link](https://cran.r-project.org/package=rjson) to CRAN documentation for a more exhaustive list of `rjson` functions and their arguments.*  

### Package 2 - RJSONIO:

Building upon the functionality of `rjson`, the `RJSONIO` package offers faster conversions and additional functions for troubleshooting the parsing process. Both `fromJSON()` and `toJSON()` are enhanced and still available, and new functions introduced, such as:  

* `isValidJSON()` for validating JSON format prior to parsing, which helps when troublehsooting errors  
* `readJSONStream()` that optimizes system memory and processing for the ingestion of streaming JSON content  

Overall, `RJSONIO` has additional options for the generation and processing of JSON content, while sharing a similar look and feel of `rjson`.   

*[Link](https://cran.r-project.org/package=RJSONIO) to CRAN documentation for a more exhaustive list of `RJSONIO` functions and their arguments.*  

### Package 3 - jsonlite:  

Originally a fork of the `RJSONIO` package, the `jsonlite` package is one of the newer options available for parsing JSON data in R. It has been designed and optimized for interaction with web APIs. The core functions of `fromJSON()` and `toJSON()` remain, however, they have been rewritten for better consistency when converting between JSON and R. Other functions for `jsonlite` include:  

* `validate()` for validating the structure of JSON content (similar to `isValidJSON()` in `RJSONIO`)  
* `prettify()` adds indentation to JSON strings for better readability  
* `minify()` for removing all indendation and whitespace  
* `stream_in()` and `stream_out()` for handling streaming JSON connections  

Overall, `jsonlite` is a fast JSON parser and useful for the conversion of JSON script into nested lists in R. Given its speed and high performance, `jsonlite` is a powerful package for anyone interested in JSON to R conversions, particularly when APIs are involved. 

*[Link](https://cran.r-project.org/package=jsonlite) to CRAN documentation for a more exhaustive list of `jsonlite` functions and their arguments.*  

## Package for this Vignette  

Given its optimization for parsing JSON script from APIs, the `jsonlite` package is used in this vignette when communicating with the API for NHL records. Its fast speed and ease of use when coupled with the `httr` package makes it a preferred candidate for converting JSON into R objects.  

In the following "NHL Franchise API" section, the `GET()` and `content()` functions from `httr` will be used to call a URL and return a JSON text string. The `fromJSON()` function from `jsonlite` will then be utilized for parsing the raw text into a R list object. Finally, the data table from the R list object will be pulled and converted into a tibble for data analysis.   

# NHL Franchise API  

## Background  

The professional hockey league across the United States and Canada is the  National Hockey League (NHL), which provides an API for public consumption. The NHL offers almost no official documentation for this connection and its available endpoints. To help navigate this API, open source documentation from this [GitLab](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) will be used to understand what data is available, relevant URL addresses, and how to filter on certain attributes in the API query.  

The following sections will focus primarily on retrieving data for NHL franchises, players (goalies and skaters), and season stats. Some numerical summaries will be presented, along with the exploration of analytical summaries containing visuals of various plots.  

## Establishing API Connection  

The base URL for the NHL API is `https://records.nhl.com/site/api` which can be called with different extensions such as `/franchise` to retrieve data from a specific endpoint, or additionally with a Franchise ID such as `26` (Carolina Hurricanes) to return data filtered on specific franchises.  

Two functions below have been created for calling the NHL API:  

* `nhlTable(tableName)` calls the provided endpoint from the user, parses, and returns a tibble of that endpoint.  
* `nhlTableWithFranchiseId(tableName,franId)` calls the provided endpoint and the desired Franchise ID from the user, parses, and returns a tibble of that endpoint filtered on the respective franchise.  

These functions will be used to call the following endpoints, creating tibbles for each:  

* `/franchise` to create table `fran`  
* `/franchise-team-totals` to create table `franTot`  
* `/franchise-season-records` to create table `franSeason`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-goalie-records` to create table `franGoal`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-skater-records` to create table `franSkate`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  

Some of these tables will be used in the upcoming section on "Exploratory Data Analysis".  

```{r nhlApiFunctions}
nhlTable <- function(tableName){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
nhlTableWithFranchiseId <- function(tableName,franId){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName,"?cayenneExp=franchiseId=",franId))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
# Function calls for 5 different endpoints, with 3 calling franchiseId=26 for data specific to the Carolina Hurricanes:
fran <- nhlTable("/franchise")
fran
franTot <- nhlTable("/franchise-team-totals")
franTot
franSeason <- nhlTableWithFranchiseId("/franchise-season-records",26)
franSeason
franGoal <- nhlTableWithFranchiseId("/franchise-goalie-records",26)
franGoal
franSkate <- nhlTableWithFranchiseId("/franchise-skater-records",26)
franSkate
```

## Exploratory Data Analysis  

### The Data  

It's important to note the franchise data for the Carolina Hurricanes dates back to 1979 when the organization was known as the Hartford Whalers. In 1997 the franchise moved to Raleigh, North Carolina and rebranded as the Carolina Hurricanes.  

Over the span of 40+ years, the organization has seen many players come through its ranks. Some have played for the team for more than a decade, while others might have only been called in for one game. The following should be noted for the remainder of this vignette and data exploration:  

* All player stats represent the contributions of that player **during** their time with the Hartford Whalers and/or Carolina Hurricanes. Seasons, goals, games played, etc ... **all are representative of the player's time with the franchise**  

Two tables from the API query will be modfied and examined further. The table `fran` with franchise data has been formatted with 2 additional variables for full team name and an active team flag. Some variables have been renamed for better understanding, columns selected in the order of desired appearance, and the overall table arranged by `teamName`.  

The table `franSkate` with skater data for the Carolina Hurricanes has been formatted with 7 additional variables:  

* 1 character type with full player name  
* 1 categorical type for player seniority based on seasons played  
* 5 numeric type with averages of key stats over number of seasons played  

More intuitive categorical values for player position have replaced the original single letter abbreviations. Columns were selected in the order of desired appearance, and the overall table arranged by `gamesPlayed`.  

A filter was applied based on `gamesPlayed`, removing any players who have not played at least 10 games for the franchise. This helps reduce the amount of ad hoc cases where a player might have been temporarily called up from a minor league team for a few days to briefly fill in for an injured regular. The effort was to have the table reflect players who have had a *notable number of games played in at least 1 season* with the franchise. This reduced the overall table size from 478 observations to 396 observations, as of 12-June-2020.  

```{r tableFormat}
# Format "fran" table and create modified version. Add 2 new variables with mutate(). Rename other variables as needed. Select relevant varibales and arrange by "teamName".
franMod <- fran %>% mutate(teamName=paste(fran$teamPlaceName,fran$teamCommonName)) %>% mutate(activeTeam=as.integer(is.na(lastSeasonId))) %>% rename("franchiseId"="id","teamId"="mostRecentTeamId") %>% select(teamName,franchiseId,teamId,firstSeasonId,lastSeasonId,activeTeam) %>% arrange(teamName)
# Format "franSkate" table and create modified version. Add 7 new variables and arrange by gamesPlayed.
franSkateMod <- franSkate %>% mutate(playerName=paste(franSkate$firstName,franSkate$lastName)) %>% mutate(avgPointsPerSeason=round(points/seasons,1)) %>% mutate(avgGoalsPerSeason=round(goals/seasons,1)) %>% mutate(avgAssistsPerSeason=round(assists/seasons,1)) %>%  mutate(avgPenaltyMinutesPerSeason=round(penaltyMinutes/seasons,1)) %>% mutate(avgGamesPlayedPerSeason=round(gamesPlayed/seasons,1)) %>% mutate(seniority=seasons) %>% arrange(desc(gamesPlayed))
# Additional format of "franSkateMod". Replace levels of categorical variable "positionCode" with full position name. Apply categorical values to newly created seniority. Replace values of "activePlayer" for appearance. Select relevant varibales in desired order.
franSkateMod$positionCode <- factor(franSkateMod$positionCode,c("C","D","L","R"),labels = c("Center","Defenseman","Left Wing","Right Wing"))
franSkateMod$seniority <- factor(ifelse(franSkateMod$seniority==1,"1 Season",ifelse(franSkateMod$seniority<=5,"2-5 Seasons","6+ Seasons")))
franSkateMod$activePlayer <- factor(ifelse(franSkateMod$activePlayer=="TRUE","Active","NonActive"))
franSkateMod <- franSkateMod %>% rename("position"="positionCode") %>% filter(gamesPlayed>=10) %>% select(playerName, playerId, activePlayer, position, seasons, seniority, gamesPlayed, points, goals, assists, penaltyMinutes, avgPointsPerSeason, avgGoalsPerSeason, avgAssistsPerSeason, avgPenaltyMinutesPerSeason, avgGamesPlayedPerSeason)
```

A preview of the two modified tables is provided for validation after formatting.   

```{r previewTables}
# Preview formatted tables
knitr::kable(head(franMod,n=7),format="html",caption="Preview of Modified Franchise Data")
knitr::kable(head(franSkateMod,n=7),format="html",caption="Preview of Modified Skater Data for Carolina Hurricanes")
```

### Numeric Summaries  

Contingecy tables are provided for the categorical variables `position`, `seniority`, and `activePlayer`. When comparing skater position vs franchise seniority, the most notable observations are:  

* The balanced amount of offensive players per level of seniority between the positions Center, Left Wing, and Right Wing  
* The relatively low number (48 out of 396) of players who stay with the franchise for at least 6 seasons or more  

When comparing active players by skater position, there are 49 players still active in the league. A NHL team can only have 23 active players at one time, so the `activePlayer` flag from the NHL API must indicate at a high level if the player still has an active career with any franchise. It would be worth exploring further to join this data set with the API `/player` endpoint to better understand which players currently play for the selected franchise and make up the 23 man roster.  

```{r contingencyTables}
# Contingency tables of frequency
knitr::kable(table(franSkateMod$position,franSkateMod$seniority),format="html",caption="Frequency of Skater Position by Franchise Seniority")
knitr::kable(table(franSkateMod$activePlayer,franSkateMod$position),format="html",caption="Frequency of Active Players by Skater Position")
```

Numeric summaries of key stats help reveal a few observations on seasons played for the franchise, goals scored, and assists given by player position. These summaries were conducted on **NonActive** players who have concluded their contributions to the franchise. Some of these are intuitive based on the name of the player position, but still worth noting:  

* The overall mean time spent with the franchise is almost constant across all 4 positions, around 3 seasons  
* Defenseman, on average, score less goals than the 3 offensive positions  
* Centers, on average, score more goals and provide more assists than all other positions  

```{r summaryOfRetiredSkaterByPosition}
# Function created that takes NonActive players by position (user-provided argument "x") and outputs a numeric summary of key stats
skateSum <- function(x=""){
  skateFun <- franSkateMod %>% filter(position==x,activePlayer=="NonActive")
  knitr::kable(cbind("Seasons Played"=round(summary(skateFun$seasons),1),"Games Played"=round(summary(skateFun$gamesPlayed),1),"Goals Scored"=round(summary(skateFun$goals),1),"Assists Given"=round(summary(skateFun$assists),1)),format="html",caption=paste("Summary of NonActive Players for Skater Position:",x))
}
# Call custom function 4 times, once per skater position.
skateSum("Defenseman")
skateSum("Center")
skateSum("Left Wing")
skateSum("Right Wing")
```

### Visuals  

A few plots help illustrate the above numeric summaries, and offer additional views into the players and their franchise stats.  

The histogram gives an overview of the number of players by seasons with the franchise. The sudden drop around 4 seasons shows the relatively short tenure most players have with the organization. There are still a few, however, who stick around for 5, 10, even 15+ years.  

The side-by-side bar chart shows the count of players by seniority, grouped by their position. It's interesting to see the relatively high number of players who are with the franchise for only 1 season, compared to the few who are around much longer. The high turnover of players after only 1 season with the team could indicate the high performance required to stay with the franchise, or in the NHL altogether.  

```{r plotsHistogramAndBar}
# Histogram creation
histSkate <- ggplot(data=franSkateMod,aes(x=seasons))
histSkate + geom_histogram(bins=15) + labs(x="Seasons Played",y="Player Count",title="Histogram of Seasons Played")
# Cluster bar chart creation
clustSkate <- ggplot(data=franSkateMod,aes(x=position))
clustSkate + geom_bar(aes(fill=as.factor(seniority)),position="dodge") + labs(x="Player Position",y="Player Count",title="Count of Player by Seniority") + scale_fill_discrete(name="")
```

Switching to player stats on the ice, the first side-by-side boxplot gives a better visual of the overall lower average in scored goals per season for Defenseman, with a very small IQR when compared to the offensive positions. Naturally, it should be expected the 3 offensive positions would have higher averages of goals scored.  

The second boxplot focuses on the average minutes per season spent off the ice in the penalty box. Unlike goals scored, there is no natural distinction between defensive and offensive positions. Centers have a lower average of time in the penalty box. This leads to interesting questions for further investigation: What is the role of a Center? Are they usually captains and leaders who need to be on the ice guiding their teammates?  

Given the high scoring average of Centers, it would be beneficial for teams to have these players in the game and avoid the penalty box as much as possible.  

```{r plotsBox}
# Boxplot 1 creation by position
boxSkateGoal <- ggplot(data=franSkateMod)
boxSkateGoal + geom_boxplot(aes(x=position,y=avgGoalsPerSeason)) + geom_jitter(aes(x=position,y=avgGoalsPerSeason,color=position)) + labs(x="Player Position",y="Average Goals Per Season",title="Boxplot for Average Goals Per Season") + theme(legend.position = "none")
# Boxplot 2 creation by position
boxSkatePenalty <- ggplot(data=franSkateMod)
boxSkatePenalty + geom_boxplot(aes(x=position,y=avgPenaltyMinutesPerSeason)) + geom_jitter(aes(x=position,y=avgPenaltyMinutesPerSeason,color=position)) + labs(x="Player Position",y="Average Penalty Minutes Per Season",title="Boxplot for Average Penalty Minutes Per Season") + theme(legend.position = "none")
```

The previous observation on Centers and their high scoring average compared to their lower average of penalty minutes gave inspiration for the first scatter plot below. Stepping away from averages, this scatter plot looks at total penalty minutes a player has with the franchise compared to their total number of goals scored. Observations are grouped by player position. The groupings are clear, and positions with higher penalty minutes see less goals scored. It would be interesting to investigate this further, and see if a player's position (Center, Left/Right Wing, or Defenseman) can be predicted if only penalty minutes and goals scored are known.  

The final visual explores the relationship between seasons played and average goals scored per season. The first observation has been noted already in other plots: Defenseman are going to have a low scoring average, no matter how many seasons they spend with their franchise.  

The offensive positions share a common element: there is a positive relationship between the length of time with the franchise compared to the number of goals scored. This could be due to ranchised players being trusted more with taking shots, or high goal scoring could be the deciding factor for a franchise to keep an offensive player on the roster for a longer period of time.  

```{r plotsScatter}
# Scatter plot 1 creation
scatterPenaltyGoal <- ggplot(data=franSkateMod,aes(x=penaltyMinutes,y=goals,color=position,group=position))
scatterPenaltyGoal + geom_point() + geom_smooth(method=lm) + labs(x="Penalty Minutes with Franchise",y="Goals Scored with Franchise",title="Total Penalty Minutes vs Total Goals Scored") + scale_colour_discrete("Player Position")
# Scatter plot 2 creation
scatterSeasonGoal <- ggplot(data=franSkateMod,aes(x=seasons,y=avgGoalsPerSeason,color=position,group=position))
scatterSeasonGoal + geom_point() + geom_smooth(method=lm) + labs(x="Seasons Played",y="Average Goals Per Season",title="Seasons Played vs Average Goals Per Season") + scale_colour_discrete("Player Position")
```
