---
title: "Project 1"
author: "Brian Sugg"
date: "6/12/2020"
output:
  rmarkdown::github_document:
    toc: true
    toc_depth: 3
  html_document:
    toc: true
    toc_depth: 3
---

```{r setupOptions, include=FALSE}
library(tidyverse)
library(Lahman)
library(formatR)
library(dplyr)
library(httr)
library(jsonlite)
knitr::opts_chunk$set(message=FALSE,tidy.opts=list(width.cutoff=70),tidy=TRUE)
```

# Introduction to JSON Data  

## Background  

JSON stands for JavaScript Object Notation and is simply a method for writing out data objects using the JavaScript language for quick and efficient transmission between servers and browsers. JavaScript is a lightweight programming language with less syntax notation that makes it easy to read, write, and store data. The lightweight structure of JSON makes it a great way to quickly and efficiently send large amounts of data with minimal wait time and storage size.  

JSON is commonly used when creating and consuming data via API connections. It can ingest text strings, numbers, boolean values, `null` values, arrays, and objects into long strings of text that get delivered to a client for processing. An example from the [Mozilla Developers](https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/JSON) webpage helps illustrate how data describing a superhero, "Molecule Man", would look in JavaScript format within a JSON file:  

`{"name":"Molecule Man","age": 29,"secretIdentity":"Dan Jukes","powers":["Radiation resistance","Turning tiny","Radiation blast"]}`

This file can be received and unpackaged by a browser for parsing back into a consumable format, such as:

```{r molecule.png, out.width="30%", echo=FALSE}
knitr::include_graphics("images/moleculeMan.PNG")
```

More information on JSON including its history and usage can be found in the [Wikipedia](https://en.wikipedia.org/wiki/JSON) community. The following sections will look further into how JSON files can be unpackaged and parsed into R, including an example connection to an API for the National Hockey League (NHL).  

## Reading JSON DATA into R  

There are several packages available for reading JSON data into R. Some of these packages, such as `rjson`, have been around for a few years providing functionality as a predecessor for future packages to improve upon. Three major packages will be discussed further below with links to their respective documentation in the Comprehensive R Archive Network (CRAN). They include:  

* `rjson`  
* `RJSONIO`  
* `jsonlite`  

In the spirit of open source development, the evolution of other packages for converting between JSON and R still continues today. This is evident in the recent release version of the [`tidyjson`](https://cran.r-project.org/package=tidyjson) package on 31-May-2020.  

### Package 1 - rjson:  

The `rjson` package was an early effort in converting data between JSON and R. Its two primary functions are:  

* `toJSON()` for converting R objects to JSON format  
* `fromJSON()` for converting from JSON format into R objects  

In early release versions, `rjson` was reportedly too slow for converting large R objects into JSON format. The need for a faster conversion would eventually lead to the creation of the `RJSONIO` package.  

*[Link](https://cran.r-project.org/package=rjson) to CRAN documentation for a more exhaustive list of `rjson` functions and their arguments.*  

### Package 2 - RJSONIO:

Building upon the functionality of `rjson`, the `RJSONIO` package offers faster conversions and additional functions for troubleshooting the parsing process. Both `fromJSON()` and `toJSON()` are enhanced and still available, and new functions introduced, such as:  

* `isValidJSON()` for validating JSON format prior to parsing, which helps when troublehsooting errors  
* `readJSONStream()` that optimizes system memory and processing for the ingestion of streaming JSON content  

Overall, `RJSONIO` has additional options for the generation and processing of JSON content, while sharing a similar look and feel of `rjson`.   

*[Link](https://cran.r-project.org/package=RJSONIO) to CRAN documentation for a more exhaustive list of `RJSONIO` functions and their arguments.*  

### Package 3 - jsonlite:  

Originally a fork of the `RJSONIO` package, the `jsonlite` package is one of the newer options available for parsing JSON data in R. It has been designed and optimized for interaction with web APIs. The core functions of `fromJSON()` and `toJSON()` remain, however, they have been rewritten for better consistency when converting between JSON and R. Other functions for `jsonlite` include:  

* `validate()` for validating the structure of JSON content (similar to `isValidJSON()` in `RJSONIO`)  
* `prettify()` adds indentation to JSON strings for better readability  
* `minify()` for removing all indendation and whitespace  
* `stream_in()` and `stream_out()` for handling streaming JSON connections  

Overall, `jsonlite` is a fast JSON parser and useful for the conversion of JSON script into nested lists in R. Given its speed and high performance, `jsonlite` is a powerful package for anyone interested in JSON to R conversions, particularly when APIs are involved. 

*[Link](https://cran.r-project.org/package=jsonlite) to CRAN documentation for a more exhaustive list of `jsonlite` functions and their arguments.*  

## Package for this Vignette  

`jsonlite` coupled with `httr`.  

Name which package will be used in the upcoming API call to NHL records, and why.  

# NHL Franchise API  

## Background  

The professional hockey leaague across the United States and Canada is the  National Hockey League (NHL), which provides an API for public consumption. The NHL offers almost no official documentation for this connection and its available endpoints. To help navigate this API, open source documentation from this [GitLab](https://gitlab.com/dword4/nhlapi/-/blob/master/records-api.md) will be used to understand what data is available, relevant URL addresses, and how to filter on certain attributes in the API query.  

The following sections will focus primarily on retrieving data for NHL franchises, players (goalies and skaters), and season stats. Some numerical summaries will be presented, along with the exploration of analytical summaries containing visuals of various plots.  

## Establishing API Connection  

The base URL for the NHL API is `https://records.nhl.com/site/api` which can be called with different extensions such as `/franchise` to retrieve data from a specific endpoint, or additionally with a Franchise ID such as `26` (Carolina Hurricanes) to return data filtered on specific franchises.  

Two functions below have been created for calling the NHL API:  

* `nhlTable(tableName)` calls the provided endpoint from the user, parses, and returns a tibble of that endpoint.  
* `nhlTableWithFranchiseId(tableName,franId)` calls the provided endpoint and the desired Franchise ID from the user, parses, and returns a tibble of that endpoint filtered on the respective franchise.  

These functions will be used to call the following endpoints, creating tibbles for each:  

* `/franchise` to create table `fran`  
* `/franchise-team-totals` to create table `franTot`  
* `/franchise-season-records` to create table `franSeason`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-goalie-records` to create table `franGoal`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  
* `/franchise-skater-records` to create table `franSkate`  
    + Filtered on Franchise ID `26` for the Carolina Hurricanes  

These tables will be used in the upcoming section on "Exploratory Data Analysis".  

```{r nhlApiFunctions}
nhlTable <- function(tableName){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
nhlTableWithFranchiseId <- function(tableName,franId){
  baseURL <- "https://records.nhl.com/site/api"
  # GET() used to retrieve information in raw form, content() transforms raw into JSON text for conversion with fromJSON().  
  queryGET <- GET(paste0(baseURL,tableName,"?cayenneExp=franchiseId=",franId))
  queryText <- content(queryGET, "text")
  queryJSON <- fromJSON(queryText, flatten = TRUE)
  # Reformat data from the returned list into a usable structure, a tibble.  
  queryList <- as.list(queryJSON) 
  queryTbl <- as_tibble(queryList[[1]])
}
# Function calls for 5 different endpoints, with 3 calling franchiseId=26 for data specific to the Carolina Hurricanes:
fran <- nhlTable("/franchise")
fran
franTot <- nhlTable("/franchise-team-totals")
franTot
franSeason <- nhlTableWithFranchiseId("/franchise-season-records",26)
franSeason
franGoal <- nhlTableWithFranchiseId("/franchise-goalie-records",26)
franGoal
franSkate <- nhlTableWithFranchiseId("/franchise-skater-records",26)
franSkate
```

## Exploratory Data Analysis  

### The Data  

Check for any needed formatting, create a new variable as required (think teamName from franchise table).  

### Numeric Summaries  

Provide contingecy tables and numeric summaries as required.  

### Visuals  

Create some plots (bar, box, scatter) with discussion of observations for each.  
